name: Build + Deploy React to WordPress (Debug Upload)

on:
  push:
    branches: ["main"]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "npm"
          cache-dependency-path: React-App/package-lock.json

      - name: Install dependencies
        working-directory: React-App
        run: npm ci

      - name: Build React app
        working-directory: React-App
        run: npm run build

      - name: Upload assets + update WordPress Home page (DEBUG)
        working-directory: React-App
        env:
          WP_BASE_URL: ${{ secrets.WP_BASE_URL }} # https://sites.brown.edu/songlab
          WP_USERNAME: ${{ secrets.WP_USERNAME }}
          WP_APP_PASSWORD: ${{ secrets.WP_APP_PASSWORD }}
          WP_PAGE_ID: ${{ secrets.WP_PAGE_ID }} # 192
        run: |
          set -euo pipefail

          echo "== Preparing auth =="
          AUTH="$(printf "%s:%s" "$WP_USERNAME" "$WP_APP_PASSWORD" | base64 -w 0)"
          MEDIA_API="$WP_BASE_URL/wp-json/wp/v2/media"
          PAGE_API="$WP_BASE_URL/wp-json/wp/v2/pages/$WP_PAGE_ID"

          echo "MEDIA_API: $MEDIA_API"
          echo "PAGE_API:  $PAGE_API"
          echo ""

          echo "== Listing build outputs =="
          ls -la dist/assets
          echo ""

          echo "== Uploading app.js =="
          js_resp="$(curl -sS -w '\nHTTP_STATUS:%{http_code}\n' -X POST "$MEDIA_API" \
            -H "Authorization: Basic $AUTH" \
            -H "Content-Disposition: attachment; filename=app.js" \
            -H "Content-Type: application/javascript" \
            --data-binary @dist/assets/app.js)"

          echo "$js_resp"
          js_status="$(echo "$js_resp" | sed -n 's/^HTTP_STATUS://p')"
          js_body="$(echo "$js_resp" | sed '/^HTTP_STATUS:/d')"

          echo ""
          echo "== Uploading app.css =="
          css_resp="$(curl -sS -w '\nHTTP_STATUS:%{http_code}\n' -X POST "$MEDIA_API" \
            -H "Authorization: Basic $AUTH" \
            -H "Content-Disposition: attachment; filename=app.css" \
            -H "Content-Type: text/css" \
            --data-binary @dist/assets/app.css)"

          echo "$css_resp"
          css_status="$(echo "$css_resp" | sed -n 's/^HTTP_STATUS://p')"
          css_body="$(echo "$css_resp" | sed '/^HTTP_STATUS:/d')"

          echo ""
          echo "JS upload HTTP status:  $js_status"
          echo "CSS upload HTTP status: $css_status"
          echo ""

          js_url=""
          css_url=""

          if [[ "$js_status" == "201" ]]; then
            js_url="$(echo "$js_body" | python3 -c "import sys, json; print(json.load(sys.stdin).get('source_url',''))")"
          fi

          if [[ "$css_status" == "201" ]]; then
            css_url="$(echo "$css_body" | python3 -c "import sys, json; print(json.load(sys.stdin).get('source_url',''))")"
          fi

          if [[ -z "$js_url" || -z "$css_url" ]]; then
            echo "‚ùå Upload failed"
            echo "js_url=$js_url"
            echo "css_url=$css_url"
            exit 1
          fi

          echo "‚úÖ Uploaded assets:"
          echo "JS:  $js_url"
          echo "CSS: $css_url"
          echo ""

          echo "== Updating Home page content =="
          content="<div id=\"songlab-root\"></div>\n\n<link rel=\"stylesheet\" href=\"$css_url\" />\n<script type=\"module\" src=\"$js_url\"></script>\n"

          payload="$(python3 -c "import json,sys; print(json.dumps({'content': sys.argv[1]}))" "$content")"

          update_resp="$(curl -sS -X POST "$PAGE_API" \
            -H "Authorization: Basic $AUTH" \
            -H "Content-Type: application/json" \
            --data "$payload")"

          echo "$update_resp"

          page_link="$(echo "$update_resp" | python3 -c "import sys, json; print(json.load(sys.stdin).get('link',''))")"

          if [[ -z "$page_link" ]]; then
            echo "‚ùå Page update failed"
            exit 1
          fi

          echo "üéâ Updated homepage: $page_link"
