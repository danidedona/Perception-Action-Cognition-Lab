name: Build + Deploy React to WordPress (Media + Update Home Page)

on:
  push:
    branches: ["main"]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "npm"
          cache-dependency-path: React-App/package-lock.json

      - name: Install
        working-directory: React-App
        run: npm ci

      - name: Build
        working-directory: React-App
        run: npm run build

      - name: Upload assets + update WordPress Home page
        working-directory: React-App
        env:
          WP_BASE_URL: ${{ secrets.WP_BASE_URL }}          # https://sites.brown.edu/songlab
          WP_USERNAME: ${{ secrets.WP_USERNAME }}
          WP_APP_PASSWORD: ${{ secrets.WP_APP_PASSWORD }}
          WP_PAGE_ID: ${{ secrets.WP_PAGE_ID }}            # 192
        run: |
          set -euo pipefail

          AUTH="$(printf "%s:%s" "$WP_USERNAME" "$WP_APP_PASSWORD" | base64 -w 0)"
          MEDIA_API="$WP_BASE_URL/wp-json/wp/v2/media"
          PAGE_API="$WP_BASE_URL/wp-json/wp/v2/pages/$WP_PAGE_ID"

          js_url=""
          css_url=""

          echo "Uploading dist/assets JS/CSS to WordPress Media…"
          shopt -s nullglob
          for file in dist/assets/*.{js,css}; do
            fname="$(basename "$file")"
            mime="application/octet-stream"
            if [[ "$fname" == *.js ]]; then mime="text/javascript"; fi
            if [[ "$fname" == *.css ]]; then mime="text/css"; fi

            echo "→ Uploading $fname"

            resp="$(curl -sS -X POST "$MEDIA_API" \
              -H "Authorization: Basic $AUTH" \
              -H "Content-Disposition: attachment; filename=$fname" \
              -H "Content-Type: $mime" \
              --data-binary @"$file")"

            url="$(echo "$resp" | python3 -c "import sys, json; print(json.load(sys.stdin).get('source_url',''))")"
            if [[ -z "$url" ]]; then
              echo "Upload failed:"
              echo "$resp"
              exit 1
            fi

            echo "   Uploaded URL: $url"

            if [[ "$fname" == *.js ]]; then js_url="$url"; fi
            if [[ "$fname" == *.css ]]; then css_url="$url"; fi
          done

          if [[ -z "$js_url" || -z "$css_url" ]]; then
            echo "Missing JS or CSS URL. JS=$js_url CSS=$css_url"
            exit 1
          fi

          new_content=$(cat <<EOF
<div id="songlab-root"></div>

<link rel="stylesheet" href="$css_url" />
<script type="module" src="$js_url"></script>
EOF
          )

          payload="$(NEW_CONTENT="$new_content" python3 - <<'PY'
import json, os
print(json.dumps({"content": os.environ["NEW_CONTENT"]}))
PY
          )"

          echo "Updating WordPress page $WP_PAGE_ID…"
          update_resp="$(curl -sS -X POST "$PAGE_API" \
            -H "Authorization: Basic $AUTH" \
            -H "Content-Type: application/json" \
            --data "$payload")"

          link="$(echo "$update_resp" | python3 -c "import sys, json; print(json.load(sys.stdin).get('link',''))")"
          if [[ -z "$link" ]]; then
            echo "Page update failed:"
            echo "$update_resp"
            exit 1
          fi

          echo "✅ Updated homepage: $link"
