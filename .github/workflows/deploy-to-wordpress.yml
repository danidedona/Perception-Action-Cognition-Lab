name: Build + Deploy React to WordPress (Media + Update Home Page)

on:
  push:
    branches: ["main"]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "npm"
          cache-dependency-path: React-App/package-lock.json

      - name: Install
        working-directory: React-App
        run: npm ci

      - name: Build
        working-directory: React-App
        run: npm run build

      - name: Upload assets + update WordPress Home page
        working-directory: React-App
        env:
          WP_BASE_URL: ${{ secrets.WP_BASE_URL }}
          WP_USERNAME: ${{ secrets.WP_USERNAME }}
          WP_APP_PASSWORD: ${{ secrets.WP_APP_PASSWORD }}
          WP_PAGE_ID: ${{ secrets.WP_PAGE_ID }}
        run: |
          set -euo pipefail

          AUTH="$(printf "%s:%s" "$WP_USERNAME" "$WP_APP_PASSWORD" | base64 -w 0)"
          MEDIA_API="$WP_BASE_URL/wp-json/wp/v2/media"
          PAGE_API="$WP_BASE_URL/wp-json/wp/v2/pages/$WP_PAGE_ID"

          # Upload files and capture returned URLs
          js_url="$(curl -sS -X POST "$MEDIA_API" \
            -H "Authorization: Basic $AUTH" \
            -H "Content-Disposition: attachment; filename=app.js" \
            -H "Content-Type: text/javascript" \
            --data-binary @dist/assets/app.js \
            | python3 -c "import sys, json; print(json.load(sys.stdin).get('source_url',''))")"

          css_url="$(curl -sS -X POST "$MEDIA_API" \
            -H "Authorization: Basic $AUTH" \
            -H "Content-Disposition: attachment; filename=app.css" \
            -H "Content-Type: text/css" \
            --data-binary @dist/assets/app.css \
            | python3 -c "import sys, json; print(json.load(sys.stdin).get('source_url',''))")"

          if [[ -z "$js_url" || -z "$css_url" ]]; then
            echo "Upload failed. js_url=$js_url css_url=$css_url"
            exit 1
          fi

          echo "JS URL:  $js_url"
          echo "CSS URL: $css_url"

          # Create page content (no heredoc to keep YAML simple)
          content="<div id=\"songlab-root\"></div>\n\n<link rel=\"stylesheet\" href=\"$css_url\" />\n<script type=\"module\" src=\"$js_url\"></script>\n"

          # JSON-encode and update the page content
          payload="$(python3 -c "import json,sys; print(json.dumps({'content': sys.argv[1]}))" "$content")"

          update_resp="$(curl -sS -X POST "$PAGE_API" \
            -H "Authorization: Basic $AUTH" \
            -H "Content-Type: application/json" \
            --data "$payload")"

          link="$(echo "$update_resp" | python3 -c "import sys, json; print(json.load(sys.stdin).get('link',''))")"
          if [[ -z "$link" ]]; then
            echo "Page update failed:"
            echo "$update_resp"
            exit 1
          fi

          echo "âœ… Updated homepage: $link"
